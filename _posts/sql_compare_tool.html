---
layout: default
title: "æ•°æ®è¡¨å¯¹æ¯”SQLç”Ÿæˆå·¥å…·"
date: 2025-01-14 10:00:00 +0800
categories: [å·¥å…·, SQL, æ•°æ®åº“]
tags: [SQL, Hive, æ•°æ®å¯¹æ¯”, å·¥å…·]
description: "æ™ºèƒ½ç”ŸæˆHiveè¡¨æ•°æ®å¯¹æ¯”SQLï¼Œæ”¯æŒAPIè·å–è¡¨ç»“æ„å’Œæ‰‹åŠ¨è¾“å…¥ä¸¤ç§æ¨¡å¼çš„åœ¨çº¿å·¥å…·"
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®è¡¨å¯¹æ¯”SQLç”Ÿæˆå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .mode-selector {
            margin-bottom: 30px;
            text-align: center;
        }

        .mode-btn {
            padding: 12px 30px;
            margin: 0 10px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            min-height: 200px;
            resize: vertical;
            font-family: 'Courier New', monospace;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .col {
            flex: 1;
        }

        .api-section {
            display: none;
        }

        .manual-section {
            display: block;
        }

        /* å­—æ®µæ˜ å°„ç›¸å…³æ ·å¼ */
        #mappingContainer {
            display: none;
        }

        .field-mapping-container {
            position: relative;
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            min-height: 400px;
        }

        .field-list {
            flex: 1;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background: white;
            max-height: 500px;
            overflow-y: auto;
        }

        .field-list h4 {
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .field-item {
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .field-item:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            transform: translateX(5px);
        }

        .field-item.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .field-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .field-comment {
            font-size: 12px;
            opacity: 0.8;
        }

        .mapping-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .mapping-line {
            fill: none;
            stroke: #667eea;
            stroke-width: 2;
            opacity: 0.7;
        }

        .mapping-line-primary {
            stroke: #ff9800;
            stroke-width: 3;
            opacity: 0.9;
        }

        .mapping-list {
            margin-top: 20px;
        }

        .mapping-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }

        .mapping-item.primary {
            border-color: #ff9800;
            background: #fff8e1;
        }

        .result-container {
            display: none;
            margin-top: 30px;
        }

        .sql-result {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
        }

        /* è‡ªå®šä¹‰å¼¹çª—æ ·å¼ */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content p {
            margin-bottom: 25px;
            color: #666;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .content {
                padding: 20px;
            }

            .row {
                flex-direction: column;
            }

            .field-mapping-container {
                flex-direction: column;
                min-height: auto;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æ•°æ®è¡¨å¯¹æ¯”SQLç”Ÿæˆå·¥å…·</h1>
            <p>æ™ºèƒ½ç”ŸæˆHiveè¡¨æ•°æ®å¯¹æ¯”SQLï¼Œæ”¯æŒAPIè·å–è¡¨ç»“æ„å’Œæ‰‹åŠ¨è¾“å…¥ä¸¤ç§æ¨¡å¼</p>
        </div>

        <div class="content">
            <!-- è¿›åº¦æ¡ -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar"></div>
                </div>
            </div>

            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="mode-selector">
                <button class="mode-btn" id="apiModeBtn" onclick="switchMode('api')">APIæ¨¡å¼</button>
                <button class="mode-btn active" id="manualModeBtn" onclick="switchMode('manual')">æ‰‹åŠ¨è¾“å…¥æ¨¡å¼</button>
            </div>

            <!-- APIæ¨¡å¼ -->
            <div class="api-section" id="apiSection">
                <div class="section">
                    <h3>ğŸ“¡ APIé…ç½®</h3>
                    <div class="alert alert-info">
                        <strong>æç¤ºï¼š</strong> è¯·ç¡®ä¿APIæœåŠ¡æ­£å¸¸è¿è¡Œï¼Œå¹¶ä¸”å·²é…ç½®æ­£ç¡®çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€‚
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="apiUrl">APIåœ°å€:</label>
                                <input type="text" id="apiUrl" class="form-control" 
                                       placeholder="http://localhost:8080/api/table-structure" 
                                       value="http://localhost:8080/api/table-structure">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="useProxy">ä½¿ç”¨ä»£ç†:</label>
                                <select id="useProxy" class="form-control">
                                    <option value="false">å¦</option>
                                    <option value="true">æ˜¯</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>ğŸ·ï¸ è¡¨ä¿¡æ¯é…ç½®</h3>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="onlineTableName">çº¿ä¸Šè¡¨å:</label>
                                <input type="text" id="onlineTableName" class="form-control" 
                                       placeholder="ä¾‹å¦‚: dim_pub_hr_empl_cho_cockpit_org_info_his_da">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="testTableName">æµ‹è¯•è¡¨å:</label>
                                <input type="text" id="testTableName" class="form-control" 
                                       placeholder="ä¾‹å¦‚: dim_pub_hr_empl_cho_cockpit_org_test_info_his_da">
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-primary" onclick="fetchTableStructures()">ğŸ”„ è·å–è¡¨ç»“æ„</button>
                        <button class="btn btn-secondary" onclick="loadExampleData()">ğŸ“ åŠ è½½ç¤ºä¾‹æ•°æ®</button>
                    </div>
                </div>
            </div>

            <!-- æ‰‹åŠ¨è¾“å…¥æ¨¡å¼ -->
            <div class="manual-section" id="manualSection">
                <div class="section">
                    <h3>ğŸ“ å»ºè¡¨è¯­å¥è¾“å…¥</h3>
                    <div class="alert alert-info">
                        <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong> è¯·åˆ†åˆ«è¾“å…¥çº¿ä¸Šè¡¨å’Œæµ‹è¯•è¡¨çš„å®Œæ•´å»ºè¡¨è¯­å¥ï¼ˆCREATE TABLEè¯­å¥ï¼‰
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label for="onlineTableDDL">çº¿ä¸Šè¡¨å»ºè¡¨è¯­å¥:</label>
                                <textarea id="onlineTableDDL" class="form-control" 
                                          placeholder="è¯·è¾“å…¥çº¿ä¸Šè¡¨çš„CREATE TABLEè¯­å¥..."></textarea>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label for="testTableDDL">æµ‹è¯•è¡¨å»ºè¡¨è¯­å¥:</label>
                                <textarea id="testTableDDL" class="form-control" 
                                          placeholder="è¯·è¾“å…¥æµ‹è¯•è¡¨çš„CREATE TABLEè¯­å¥..."></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button class="btn btn-primary" onclick="parseTableStructure()">ğŸ” è§£æè¡¨ç»“æ„</button>
                        <button class="btn btn-secondary" onclick="loadExampleDDL()">ğŸ“ åŠ è½½ç¤ºä¾‹DDL</button>
                    </div>
                </div>
            </div>

            <!-- å­—æ®µæ˜ å°„é…ç½® -->
            <div id="mappingContainer">
                <div class="section">
                    <h3>ğŸ”— å­—æ®µæ˜ å°„é…ç½®</h3>
                    <div class="alert alert-info">
                        <strong>æ“ä½œè¯´æ˜ï¼š</strong> 
                        <br>1. ç‚¹å‡»"è‡ªåŠ¨æ˜ å°„åŒåå­—æ®µ"è¿›è¡Œå¿«é€Ÿæ˜ å°„
                        <br>2. æˆ–è€…åˆ†åˆ«ç‚¹å‡»å·¦å³ä¸¤ä¾§çš„å­—æ®µè¿›è¡Œæ‰‹åŠ¨æ˜ å°„
                        <br>3. åœ¨æ˜ å°„åˆ—è¡¨ä¸­è®¾ç½®ä¸»é”®å­—æ®µï¼ˆç”¨äºå…³è”å¯¹æ¯”ï¼‰
                        <br>4. å®Œæˆåç‚¹å‡»"ç¡®è®¤æ˜ å°„"è¿›å…¥ä¸‹ä¸€æ­¥
                    </div>
                    
                    <div class="text-center" style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="autoMapping()">ğŸ¤– è‡ªåŠ¨æ˜ å°„åŒåå­—æ®µ</button>
                        <button class="btn btn-secondary" onclick="clearMapping()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ˜ å°„</button>
                        <button class="btn btn-primary" onclick="confirmMapping()">âœ… ç¡®è®¤æ˜ å°„</button>
                    </div>

                    <div class="field-mapping-container" id="fieldMappingContainer">
                        <svg class="mapping-lines" id="mappingLines"></svg>
                        
                        <div class="field-list">
                            <h4>çº¿ä¸Šè¡¨å­—æ®µ</h4>
                            <div id="onlineFields"></div>
                        </div>
                        
                        <div class="field-list">
                            <h4>æµ‹è¯•è¡¨å­—æ®µ</h4>
                            <div id="testFields"></div>
                        </div>
                    </div>

                    <div class="mapping-list" id="mappingList">
                        <div class="alert alert-warning">æš‚æ— å­—æ®µæ˜ å°„ï¼Œè¯·é€‰æ‹©å­—æ®µè¿›è¡Œæ˜ å°„</div>
                    </div>
                </div>
            </div>

            <!-- ç”ŸæˆSQL -->
            <div class="section">
                <h3>âš¡ ç”Ÿæˆå¯¹æ¯”SQL</h3>
                <div class="text-center">
                    <button class="btn btn-primary" id="generateBtn" onclick="generateSQL()" disabled>
                        ğŸš€ ç”Ÿæˆå¯¹æ¯”SQL
                    </button>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div class="result-container" id="resultContainer">
                <div class="section">
                    <h3>ğŸ“‹ ç”Ÿæˆçš„SQLè¯­å¥</h3>
                    <div class="text-center" style="margin-bottom: 20px;">
                        <button class="btn btn-success" onclick="copySQL()">ğŸ“‹ å¤åˆ¶SQL</button>
                    </div>
                    <div class="sql-result" id="resultSQL"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å¼¹çª— -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <h3 id="modalTitle">æç¤º</h3>
            <p id="modalMessage"></p>
            <div class="modal-buttons" id="modalButtons">
                <button class="btn btn-primary" onclick="closeModal()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentMode = 'manual';
        let onlineTableInfo = { tableName: '', fields: [] };
        let testTableInfo = { tableName: '', fields: [] };
        let fieldMappings = [];
        let primaryKeys = [];
        let selectedOnlineField = null;
        let selectedTestField = null;

        /**
         * é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
         */
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressBar(25);
            
            // æ£€æŸ¥æ˜¯å¦åœ¨éHTTPSç¯å¢ƒä¸‹ä½¿ç”¨ä»£ç†æ¨¡å¼
            if (location.protocol !== 'https:' && document.getElementById('useProxy').value === 'true') {
                console.warn('å½“å‰é¡µé¢ä¸æ˜¯HTTPSï¼Œä»£ç†æ¨¡å¼å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ');
            }
        });

        /**
         * åˆ‡æ¢æ¨¡å¼
         */
        function switchMode(mode) {
            currentMode = mode;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('apiModeBtn').classList.toggle('active', mode === 'api');
            document.getElementById('manualModeBtn').classList.toggle('active', mode === 'manual');
            
            // æ˜¾ç¤º/éšè—å¯¹åº”åŒºåŸŸ
            document.getElementById('apiSection').style.display = mode === 'api' ? 'block' : 'none';
            document.getElementById('manualSection').style.display = mode === 'manual' ? 'block' : 'none';
            
            // é‡ç½®çŠ¶æ€
            resetState();
        }

        /**
         * é‡ç½®çŠ¶æ€
         */
        function resetState() {
            onlineTableInfo = { tableName: '', fields: [] };
            testTableInfo = { tableName: '', fields: [] };
            fieldMappings = [];
            primaryKeys = [];
            selectedOnlineField = null;
            selectedTestField = null;
            
            document.getElementById('mappingContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;
            updateProgressBar(25);
        }

        /**
         * é€šè¿‡APIè·å–è¡¨ç»“æ„
         */
        async function fetchTableStructures() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const onlineTableName = document.getElementById('onlineTableName').value.trim();
            const testTableName = document.getElementById('testTableName').value.trim();
            const useProxy = document.getElementById('useProxy').value === 'true';

            if (!apiUrl || !onlineTableName || !testTableName) {
                showAlert('è¯·å¡«å†™å®Œæ•´çš„APIåœ°å€å’Œè¡¨åä¿¡æ¯!');
                return;
            }

            // æ£€æŸ¥ä»£ç†æ¨¡å¼ä¸‹çš„Cookieè­¦å‘Š
            if (useProxy && location.protocol !== 'https:') {
                showAlert('è­¦å‘Šï¼šå½“å‰é¡µé¢ä¸æ˜¯HTTPSï¼Œä»£ç†æ¨¡å¼å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚å»ºè®®ä½¿ç”¨HTTPSè®¿é—®æˆ–å…³é—­ä»£ç†æ¨¡å¼ã€‚');
            }

            try {
                // è·å–çº¿ä¸Šè¡¨ç»“æ„
                const onlineResponse = await fetchWithProxy(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tableName: onlineTableName
                    })
                }, useProxy);

                if (!onlineResponse.ok) {
                    throw new Error(`è·å–çº¿ä¸Šè¡¨ç»“æ„å¤±è´¥: ${onlineResponse.status}`);
                }

                const onlineData = await onlineResponse.json();

                // è·å–æµ‹è¯•è¡¨ç»“æ„
                const testResponse = await fetchWithProxy(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tableName: testTableName
                    })
                }, useProxy);

                if (!testResponse.ok) {
                    throw new Error(`è·å–æµ‹è¯•è¡¨ç»“æ„å¤±è´¥: ${testResponse.status}`);
                }

                const testData = await testResponse.json();

                // å¤„ç†è¿”å›çš„æ•°æ®
                onlineTableInfo = {
                    tableName: onlineTableName,
                    fields: onlineData.fields || []
                };

                testTableInfo = {
                    tableName: testTableName,
                    fields: testData.fields || []
                };

                if (onlineTableInfo.fields.length === 0 || testTableInfo.fields.length === 0) {
                    showAlert('è·å–åˆ°çš„è¡¨ç»“æ„ä¸ºç©ºï¼Œè¯·æ£€æŸ¥è¡¨åæ˜¯å¦æ­£ç¡®!');
                    return;
                }

                // æ˜¾ç¤ºæ˜ å°„ç•Œé¢
                document.getElementById('mappingContainer').style.display = 'block';
                updateProgressBar(50);
                
                // æ¸²æŸ“å­—æ®µåˆ—è¡¨
                renderFieldList('onlineFields', onlineTableInfo.fields, 'online');
                renderFieldList('testFields', testTableInfo.fields, 'test');

                showAlert(`è·å–è¡¨ç»“æ„æˆåŠŸ!\nçº¿ä¸Šè¡¨: ${onlineTableInfo.tableName} (${onlineTableInfo.fields.length}ä¸ªå­—æ®µ)\næµ‹è¯•è¡¨: ${testTableInfo.tableName} (${testTableInfo.fields.length}ä¸ªå­—æ®µ)`);

            } catch (error) {
                showAlert('è·å–è¡¨ç»“æ„æ—¶å‡ºé”™: ' + error.message);
                console.error('APIè¯·æ±‚é”™è¯¯:', error);
            }
        }

        /**
         * å¸¦ä»£ç†çš„fetchè¯·æ±‚
         */
        async function fetchWithProxy(url, options, useProxy) {
            if (!useProxy) {
                return fetch(url, options);
            }

            // ä»£ç†æ¨¡å¼ä¸‹çš„è¯·æ±‚å¤„ç†
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/' + url;
            return fetch(proxyUrl, {
                ...options,
                headers: {
                    ...options.headers,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
        }

        /**
         * æ˜¾ç¤ºè‡ªå®šä¹‰å¼¹çª—
         */
        function showAlert(message, title = 'æç¤º') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalButtons').innerHTML = 
                '<button class="btn btn-primary" onclick="closeModal()">ç¡®å®š</button>';
            document.getElementById('customModal').style.display = 'block';
        }

        /**
         * æ˜¾ç¤ºç¡®è®¤å¼¹çª—
         */
        function showConfirm(message, onConfirm, title = 'ç¡®è®¤') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalButtons').innerHTML = `
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmAction()">ç¡®å®š</button>
            `;
            
            // ä¿å­˜ç¡®è®¤å›è°ƒ
            window.currentConfirmCallback = onConfirm;
            document.getElementById('customModal').style.display = 'block';
        }

        /**
         * ç¡®è®¤æ“ä½œ
         */
        function confirmAction() {
            if (window.currentConfirmCallback) {
                window.currentConfirmCallback();
                window.currentConfirmCallback = null;
            }
            closeModal();
        }

        /**
         * å…³é—­å¼¹çª—
         */
        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

        /**
         * åŠ è½½ç¤ºä¾‹æ•°æ®
         */
        function loadExampleData() {
            document.getElementById('onlineTableName').value = 'dim_pub_hr_empl_cho_cockpit_org_info_his_da';
            document.getElementById('testTableName').value = 'dim_pub_hr_empl_cho_cockpit_org_test_info_his_da';
            showAlert('ç¤ºä¾‹æ•°æ®å·²åŠ è½½ï¼Œè¯·ç‚¹å‡»"è·å–è¡¨ç»“æ„"æŒ‰é’®');
        }

        /**
         * åŠ è½½ç¤ºä¾‹DDL
         */
        function loadExampleDDL() {
            document.getElementById('onlineTableDDL').value = getExampleOnlineDDL();
            document.getElementById('testTableDDL').value = getExampleTestDDL();
            showAlert('ç¤ºä¾‹DDLå·²åŠ è½½ï¼Œè¯·ç‚¹å‡»"è§£æè¡¨ç»“æ„"æŒ‰é’®');
        }

        /**
         * è·å–ç¤ºä¾‹çº¿ä¸Šè¡¨DDL
         */
        function getExampleOnlineDDL() {
            return `CREATE EXTERNAL TABLE \`dim_pub_hr_empl_cho_cockpit_org_info_his_da\`(
  \`empl_id\` string COMMENT 'å‘˜å·¥ID', 
  \`empl_name\` string COMMENT 'å‘˜å·¥å§“å', 
  \`org_id\` string COMMENT 'ç»„ç»‡ID', 
  \`org_name\` string COMMENT 'ç»„ç»‡åç§°', 
  \`org_level\` string COMMENT 'ç»„ç»‡å±‚çº§', 
  \`org_type_code\` string COMMENT 'ç»„ç»‡ç±»å‹ç¼–ç ', 
  \`org_type_name\` string COMMENT 'ç»„ç»‡ç±»å‹åç§°', 
  \`org_range_code\` string COMMENT 'ç»„ç»‡èŒƒå›´ç¼–ç ', 
  \`org_range_name\` string COMMENT 'ç»„ç»‡èŒƒå›´åç§°', 
  \`plat_city_level1_category_code\` string COMMENT 'æ€»éƒ¨åŸå¸‚ä¸€çº§åˆ†ç±»ç¼–ç ', 
  \`plat_city_level1_category_name\` string COMMENT 'æ€»éƒ¨åŸå¸‚ä¸€çº§åˆ†ç±»åç§°', 
  \`plat_city_level2_category_code\` string COMMENT 'æ€»éƒ¨åŸå¸‚äºŒçº§åˆ†ç±»ç¼–ç ', 
  \`plat_city_level2_category_name\` string COMMENT 'æ€»éƒ¨åŸå¸‚äºŒçº§åˆ†ç±»åç§°'
)
PARTITIONED BY ( 
  \`pt\` string)
ROW FORMAT DELIMITED 
  FIELDS TERMINATED BY '\\u0001' 
STORED AS INPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat' 
OUTPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'
LOCATION
  'hdfs://ns-fed/user/bigdata/dim/dim_pub_hr_empl_cho_cockpit_org_info_his_da'`;
        }

        /**
         * è·å–ç¤ºä¾‹æµ‹è¯•è¡¨DDL
         */
        function getExampleTestDDL() {
            return `CREATE EXTERNAL TABLE \`dim_pub_hr_empl_cho_cockpit_org_test_info_his_da\`(
  \`empl_id\` string COMMENT 'å‘˜å·¥ID', 
  \`empl_name\` string COMMENT 'å‘˜å·¥å§“å', 
  \`org_id\` string COMMENT 'ç»„ç»‡ID', 
  \`org_name\` string COMMENT 'ç»„ç»‡åç§°', 
  \`org_level\` string COMMENT 'ç»„ç»‡å±‚çº§', 
  \`org_type_code\` string COMMENT 'ç»„ç»‡ç±»å‹ç¼–ç ', 
  \`org_type_name\` string COMMENT 'ç»„ç»‡ç±»å‹åç§°', 
  \`org_range_code\` string COMMENT 'ç»„ç»‡èŒƒå›´ç¼–ç ', 
  \`org_range_name\` string COMMENT 'ç»„ç»‡èŒƒå›´åç§°', 
  \`plat_city_level1_category_code\` string COMMENT 'æ€»éƒ¨åŸå¸‚ä¸€çº§åˆ†ç±»ç¼–ç ', 
  \`plat_city_level1_category_name\` string COMMENT 'æ€»éƒ¨åŸå¸‚ä¸€çº§åˆ†ç±»åç§°', 
  \`plat_city_level2_category_code\` string COMMENT 'æ€»éƒ¨åŸå¸‚äºŒçº§åˆ†ç±»ç¼–ç ', 
  \`plat_city_level2_category_name\` string COMMENT 'æ€»éƒ¨åŸå¸‚äºŒçº§åˆ†ç±»åç§°'
)
PARTITIONED BY ( 
  \`pt\` string)
ROW FORMAT DELIMITED 
  FIELDS TERMINATED BY '\\u0001' 
STORED AS INPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat' 
OUTPUTFORMAT 
  'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat'
LOCATION
  'hdfs://ns-fed/user/bigdata/dim/dim_pub_hr_empl_cho_cockpit_org_test_info_his_da'`;
        }

        /**
         * è§£æå»ºè¡¨è¯­å¥ï¼Œæå–è¡¨åå’Œå­—æ®µä¿¡æ¯
         */
        function parseTableStructure() {
            const onlineDDL = document.getElementById('onlineTableDDL').value.trim();
            const testDDL = document.getElementById('testTableDDL').value.trim();

            if (!onlineDDL || !testDDL) {
                showAlert('è¯·è¾“å…¥å®Œæ•´çš„å»ºè¡¨è¯­å¥!');
                return;
            }

            try {
                onlineTableInfo = parseDDL(onlineDDL);
                testTableInfo = parseDDL(testDDL);

                if (onlineTableInfo.fields.length === 0 || testTableInfo.fields.length === 0) {
                    showAlert('è§£æå»ºè¡¨è¯­å¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¯­å¥æ ¼å¼!');
                    return;
                }

                // æ˜¾ç¤ºæ˜ å°„ç•Œé¢
                document.getElementById('mappingContainer').style.display = 'block';
                updateProgressBar(50);
                
                // æ¸²æŸ“å­—æ®µåˆ—è¡¨
                renderFieldList('onlineFields', onlineTableInfo.fields, 'online');
                renderFieldList('testFields', testTableInfo.fields, 'test');

                showAlert(`è§£ææˆåŠŸ!\nçº¿ä¸Šè¡¨: ${onlineTableInfo.tableName} (${onlineTableInfo.fields.length}ä¸ªå­—æ®µ)\næµ‹è¯•è¡¨: ${testTableInfo.tableName} (${testTableInfo.fields.length}ä¸ªå­—æ®µ)`);
            } catch (error) {
                showAlert('è§£æå»ºè¡¨è¯­å¥æ—¶å‡ºé”™: ' + error.message);
            }
        }

        /**
         * è§£æDDLè¯­å¥
         */
        function parseDDL(ddl) {
            const tableNameMatch = ddl.match(/CREATE\s+(?:EXTERNAL\s+)?TABLE\s+`?([^`\s(]+)`?/i);
            if (!tableNameMatch) {
                throw new Error('æ— æ³•è§£æè¡¨å');
            }

            const tableName = tableNameMatch[1];
            const fields = [];

            // æå–å­—æ®µå®šä¹‰éƒ¨åˆ†
            const fieldSectionMatch = ddl.match(/\(([\s\S]*?)\)\s*(?:PARTITIONED|ROW|STORED|LOCATION|$)/i);
            if (!fieldSectionMatch) {
                throw new Error('æ— æ³•è§£æå­—æ®µå®šä¹‰');
            }

            const fieldSection = fieldSectionMatch[1];
            
            // è§£ææ¯ä¸ªå­—æ®µ
            const fieldLines = fieldSection.split(',').map(line => line.trim()).filter(line => line);
            
            for (let line of fieldLines) {
                // è·³è¿‡åˆ†åŒºå­—æ®µç­‰éæ•°æ®å­—æ®µ
                if (line.toLowerCase().includes('partitioned by')) break;
                
                const fieldMatch = line.match(/`?([^`\s]+)`?\s+(\w+)(?:\s+COMMENT\s+'([^']*)')?/i);
                if (fieldMatch) {
                    fields.push({
                        name: fieldMatch[1],
                        type: fieldMatch[2],
                        comment: fieldMatch[3] || ''
                    });
                }
            }

            return { tableName, fields };
        }

        /**
         * æ¸²æŸ“å­—æ®µåˆ—è¡¨
         */
        function renderFieldList(containerId, fields, tableType) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            fields.forEach((field, index) => {
                const fieldDiv = document.createElement('div');
                fieldDiv.className = 'field-item';
                fieldDiv.dataset.fieldName = field.name;
                fieldDiv.dataset.tableType = tableType;
                fieldDiv.dataset.index = index;

                fieldDiv.innerHTML = `
                    <div class="field-name">${field.name}</div>
                    <div class="field-comment">${field.type} - ${field.comment}</div>
                `;

                fieldDiv.onclick = () => selectField(fieldDiv, field, tableType);
                container.appendChild(fieldDiv);
            });
            
            // å»¶è¿Ÿæ›´æ–°è¿çº¿ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
            setTimeout(() => {
                updateMappingLines();
            }, 100);
        }

        /**
         * é€‰æ‹©å­—æ®µè¿›è¡Œæ˜ å°„
         */
        function selectField(element, field, tableType) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.field-item.selected').forEach(item => {
                if (item.dataset.tableType === tableType) {
                    item.classList.remove('selected');
                }
            });

            element.classList.add('selected');

            if (tableType === 'online') {
                selectedOnlineField = field;
            } else {
                selectedTestField = field;
            }

            // å¦‚æœä¸¤ä¸ªå­—æ®µéƒ½é€‰ä¸­äº†ï¼Œåˆ›å»ºæ˜ å°„
            if (selectedOnlineField && selectedTestField) {
                createMapping(selectedOnlineField, selectedTestField);
                clearSelection();
            }
        }

        /**
         * åˆ›å»ºå­—æ®µæ˜ å°„
         */
        function createMapping(onlineField, testField) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ˜ å°„
            const existingMapping = fieldMappings.find(m => 
                m.onlineField === onlineField.name || m.testField === testField.name
            );

            if (existingMapping) {
                showConfirm('å­—æ®µå·²å­˜åœ¨æ˜ å°„å…³ç³»ï¼Œæ˜¯å¦è¦†ç›–?', () => {
                    // ç§»é™¤æ—§æ˜ å°„
                    fieldMappings = fieldMappings.filter(m => m !== existingMapping);
                    
                    fieldMappings.push({
                        onlineField: onlineField.name,
                        testField: testField.name,
                        online: onlineField,
                        test: testField,
                        isPrimaryKey: false
                    });

                    updateMappingList();
                });
                return;
            }

            fieldMappings.push({
                onlineField: onlineField.name,
                testField: testField.name,
                online: onlineField,
                test: testField,
                isPrimaryKey: false
            });

            updateMappingList();
        }

        /**
         * æ¸…é™¤é€‰æ‹©çŠ¶æ€
         */
        function clearSelection() {
            selectedOnlineField = null;
            selectedTestField = null;
            document.querySelectorAll('.field-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
        }

        /**
         * è‡ªåŠ¨æ˜ å°„åŒåå­—æ®µ
         */
        function autoMapping() {
            // æ£€æŸ¥æ˜¯å¦å·²è§£æè¡¨ç»“æ„
            if (!onlineTableInfo.tableName || !testTableInfo.tableName) {
                showAlert('è¯·å…ˆè¾“å…¥å»ºè¡¨è¯­å¥å¹¶ç‚¹å‡»"è§£æè¡¨ç»“æ„"!');
                return;
            }

            fieldMappings = [];
            
            onlineTableInfo.fields.forEach(onlineField => {
                const matchingTestField = testTableInfo.fields.find(testField => 
                    testField.name === onlineField.name
                );
                
                if (matchingTestField) {
                    fieldMappings.push({
                        onlineField: onlineField.name,
                        testField: matchingTestField.name,
                        online: onlineField,
                        test: matchingTestField,
                        isPrimaryKey: false
                    });
                }
            });

            updateMappingList();
            
            if (fieldMappings.length > 0) {
                showAlert(`è‡ªåŠ¨æ˜ å°„å®Œæˆï¼Œå…±æ˜ å°„ ${fieldMappings.length} ä¸ªå­—æ®µ\n\nä¸‹ä¸€æ­¥ï¼šè¯·è®¾ç½®ä¸»é”®å­—æ®µï¼Œç„¶åç‚¹å‡»"ç¡®è®¤æ˜ å°„"`);
            } else {
                showAlert('æœªæ‰¾åˆ°åŒåå­—æ®µï¼Œè¯·æ‰‹åŠ¨è¿›è¡Œå­—æ®µæ˜ å°„\n\næ“ä½œæ–¹æ³•ï¼šåˆ†åˆ«ç‚¹å‡»å·¦å³ä¸¤ä¾§çš„å­—æ®µè¿›è¡Œæ˜ å°„');
            }
        }

        /**
         * æ¸…é™¤æ‰€æœ‰æ˜ å°„
         */
        function clearMapping() {
            showConfirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ˜ å°„å…³ç³»å—?', () => {
                fieldMappings = [];
                primaryKeys = [];
                updateMappingList();
                // ç¡®ä¿æ¸…é™¤æ‰€æœ‰è¿çº¿
                updateMappingLines();
            });
        }

        /**
         * æ›´æ–°æ˜ å°„åˆ—è¡¨æ˜¾ç¤º
         */
        function updateMappingList() {
            const container = document.getElementById('mappingList');
            
            if (fieldMappings.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">æš‚æ— å­—æ®µæ˜ å°„ï¼Œè¯·é€‰æ‹©å­—æ®µè¿›è¡Œæ˜ å°„</div>';
                return;
            }

            const primaryKeyCount = fieldMappings.filter(m => m.isPrimaryKey).length;
            let html = `<h4>å­—æ®µæ˜ å°„å…³ç³»: (${fieldMappings.length}ä¸ªå­—æ®µï¼Œ${primaryKeyCount}ä¸ªä¸»é”®)</h4>`;
            
            fieldMappings.forEach((mapping, index) => {
                html += `
                    <div class="mapping-item ${mapping.isPrimaryKey ? 'primary' : ''}">
                        <div>
                            <strong>${mapping.online.name}</strong> (${mapping.online.comment}) 
                            â†” 
                            <strong>${mapping.test.name}</strong> (${mapping.test.comment})
                            ${mapping.isPrimaryKey ? ' <span style="color: #ff9800;">[ä¸»é”®]</span>' : ''}
                        </div>
                        <div>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px; margin-right: 5px;" 
                                    onclick="togglePrimaryKey(${index})">
                                ${mapping.isPrimaryKey ? 'å–æ¶ˆä¸»é”®' : 'è®¾ä¸ºä¸»é”®'}
                            </button>
                            <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" 
                                    onclick="removeMapping(${index})">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            
            // æ›´æ–°è¿çº¿æ˜¾ç¤º
            updateMappingLines();
        }

        /**
         * æ›´æ–°æ˜ å°„è¿çº¿
         */
        function updateMappingLines() {
            const svg = document.getElementById('mappingLines');
            if (!svg) {
                return;
            }
            
            // æ¸…é™¤ç°æœ‰è¿çº¿
            svg.innerHTML = '';
            
            fieldMappings.forEach((mapping, index) => {
                const onlineElement = getFieldElement(mapping.onlineField, 'online');
                const testElement = getFieldElement(mapping.testField, 'test');
                
                if (onlineElement && testElement) {
                    const line = createMappingLine(onlineElement, testElement, mapping.isPrimaryKey);
                    svg.appendChild(line);
                }
            });
        }

        /**
         * è·å–å­—æ®µå…ƒç´ 
         */
        function getFieldElement(fieldName, tableType) {
            const containerId = tableType === 'online' ? 'onlineFields' : 'testFields';
            const container = document.getElementById(containerId);
            if (!container) return null;
            
            // æŸ¥æ‰¾åŒ…å«å­—æ®µåçš„å…ƒç´ 
            const elements = container.querySelectorAll('.field-item');
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                const fieldNameElement = element.querySelector('.field-name');
                if (fieldNameElement && fieldNameElement.textContent === fieldName) {
                    return element;
                }
            }
            return null;
        }

        /**
         * åˆ›å»ºæ˜ å°„è¿çº¿
         */
        function createMappingLine(fromElement, toElement, isPrimaryKey) {
            const mappingContainer = document.getElementById('fieldMappingContainer');
            const containerRect = mappingContainer.getBoundingClientRect();
            
            const fromRect = fromElement.getBoundingClientRect();
            const toRect = toElement.getBoundingClientRect();
            
            // è®¡ç®—ç›¸å¯¹äºå®¹å™¨çš„åæ ‡
            const fromX = fromRect.right - containerRect.left;
            const fromY = fromRect.top + fromRect.height / 2 - containerRect.top;
            const toX = toRect.left - containerRect.left;
            const toY = toRect.top + toRect.height / 2 - containerRect.top;
            
            // åˆ›å»ºSVGè·¯å¾„
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const midX = (fromX + toX) / 2;
            const pathData = `M ${fromX} ${fromY} C ${midX} ${fromY}, ${midX} ${toY}, ${toX} ${toY}`;
            
            path.setAttribute('d', pathData);
            path.setAttribute('class', isPrimaryKey ? 'mapping-line mapping-line-primary' : 'mapping-line');
            
            return path;
        }

        /**
         * åˆ‡æ¢ä¸»é”®çŠ¶æ€
         */
        function togglePrimaryKey(index) {
            fieldMappings[index].isPrimaryKey = !fieldMappings[index].isPrimaryKey;
            updateMappingList();
        }

        /**
         * ç§»é™¤æ˜ å°„
         */
        function removeMapping(index) {
            showConfirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ˜ å°„å…³ç³»å—?', () => {
                fieldMappings.splice(index, 1);
                updateMappingList();
                updateMappingLines();
            });
        }

        /**
         * ç¡®è®¤æ˜ å°„é…ç½®
         */
        function confirmMapping() {
            if (fieldMappings.length === 0) {
                showAlert('è¯·è‡³å°‘é…ç½®ä¸€ä¸ªå­—æ®µæ˜ å°„!\n\nè¯·å…ˆç‚¹å‡»"è‡ªåŠ¨æ˜ å°„åŒåå­—æ®µ"æˆ–æ‰‹åŠ¨é€‰æ‹©å­—æ®µè¿›è¡Œæ˜ å°„');
                return;
            }

            const primaryKeyMappings = fieldMappings.filter(m => m.isPrimaryKey);
            if (primaryKeyMappings.length === 0) {
                showAlert('è¯·è‡³å°‘è®¾ç½®ä¸€ä¸ªä¸»é”®å­—æ®µ!\n\nåœ¨å­—æ®µæ˜ å°„åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»å­—æ®µæ—è¾¹çš„"è®¾ä¸ºä¸»é”®"æŒ‰é’®');
                return;
            }

            updateProgressBar(75);
            document.getElementById('generateBtn').disabled = false;
            showAlert(`æ˜ å°„é…ç½®å®Œæˆ!\nå…± ${fieldMappings.length} ä¸ªå­—æ®µæ˜ å°„\nå…¶ä¸­ ${primaryKeyMappings.length} ä¸ªä¸»é”®å­—æ®µ\n\nç°åœ¨å¯ä»¥ç‚¹å‡»"ç”Ÿæˆå¯¹æ¯”SQL"æŒ‰é’®äº†ï¼`);
        }

        /**
         * ç”Ÿæˆå¯¹æ¯”SQL
         */
        function generateSQL() {
            // æ£€æŸ¥æ˜¯å¦å·²è§£æè¡¨ç»“æ„
            if (!onlineTableInfo.tableName || !testTableInfo.tableName) {
                showAlert('è¯·å…ˆè¾“å…¥å»ºè¡¨è¯­å¥å¹¶ç‚¹å‡»"è§£æè¡¨ç»“æ„"!');
                return;
            }

            if (fieldMappings.length === 0) {
                showAlert('è¯·å…ˆé…ç½®å­—æ®µæ˜ å°„!\n\næ“ä½œæ­¥éª¤:\n1. ç‚¹å‡»"è‡ªåŠ¨æ˜ å°„åŒåå­—æ®µ"æˆ–æ‰‹åŠ¨é€‰æ‹©å­—æ®µè¿›è¡Œæ˜ å°„\n2. è®¾ç½®è‡³å°‘ä¸€ä¸ªä¸»é”®å­—æ®µ\n3. ç‚¹å‡»"ç¡®è®¤æ˜ å°„"');
                return;
            }

            const primaryKeyMappings = fieldMappings.filter(m => m.isPrimaryKey);
            if (primaryKeyMappings.length === 0) {
                showAlert('è¯·è‡³å°‘è®¾ç½®ä¸€ä¸ªä¸»é”®å­—æ®µ!\n\nåœ¨å­—æ®µæ˜ å°„åˆ—è¡¨ä¸­ï¼Œç‚¹å‡»å­—æ®µæ—è¾¹çš„"è®¾ä¸ºä¸»é”®"æŒ‰é’®');
                return;
            }

            try {
                const sql = buildCompareSQL();
                document.getElementById('resultSQL').textContent = sql;
                document.getElementById('resultContainer').style.display = 'block';
                updateProgressBar(100);
                
                // å¯ç”¨æŒ‰é’®ï¼ˆå¦‚æœä¹‹å‰è¢«ç¦ç”¨ï¼‰
                document.getElementById('generateBtn').disabled = false;
                
                // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
                
                showAlert('SQLç”ŸæˆæˆåŠŸï¼è¯·æŸ¥çœ‹ä¸‹æ–¹ç»“æœã€‚');
            } catch (error) {
                showAlert('ç”ŸæˆSQLæ—¶å‡ºé”™: ' + error.message);
                console.error('SQLç”Ÿæˆé”™è¯¯:', error);
            }
        }

        /**
         * æ„å»ºå¯¹æ¯”SQLè¯­å¥
         */
        function buildCompareSQL() {
            const primaryKeyMappings = fieldMappings.filter(m => m.isPrimaryKey);
            const dataFieldMappings = fieldMappings.filter(m => !m.isPrimaryKey);
            
            // æ„å»ºSELECTå­å¥
            let selectClause = `select
     CASE
        WHEN t1.${primaryKeyMappings[0].onlineField} IS NULL THEN '${testTableInfo.tableName}ç¼ºå¤±'
        WHEN t2.${primaryKeyMappings[0].testField} IS NULL THEN '${onlineTableInfo.tableName}ç¼ºå¤±'
        ELSE 'å­—æ®µä¸ä¸€è‡´'
    END as diff_type`;

            // æ·»åŠ ä¸»é”®å­—æ®µ - å¦‚æœt1ä¸­å­—æ®µä¸ºnullåˆ™ä½¿ç”¨t2ä¸­çš„å€¼
            primaryKeyMappings.forEach(mapping => {
                selectClause += `\n    ,coalesce(t1.${mapping.onlineField}, t2.${mapping.testField}) as ${mapping.onlineField}`;
            });

            // æ·»åŠ æ•°æ®å­—æ®µå¯¹æ¯”
            dataFieldMappings.forEach(mapping => {
                selectClause += `\n    ,if(nvl(t1.${mapping.onlineField},'')<>nvl(t2.${mapping.testField},''), CONCAT_WS(',' , nvl(t1.${mapping.onlineField},'null'), nvl(t2.${mapping.testField},'null')),t1.${mapping.onlineField}) as ${mapping.onlineField}`;
            });

            // æ„å»ºFROMå­å¥ - çº¿ä¸Šè¡¨
            let fromClause = `\nfrom\n(\n    select`;
            fieldMappings.forEach((mapping, index) => {
                fromClause += `${index === 0 ? '\n' : '\n        ,'}cast(${mapping.onlineField} as string) as ${mapping.onlineField}`;
            });
            fromClause += `\n    from ${onlineTableInfo.tableName}\n    where pt='\${-1d_pt}'\n) t1`;

            // æ„å»ºJOINå­å¥ - æµ‹è¯•è¡¨
            fromClause += `\nfull outer join\n(\n    select`;
            fieldMappings.forEach((mapping, index) => {
                fromClause += `${index === 0 ? '\n' : '\n        ,'}cast(${mapping.testField} as string) as ${mapping.testField}`;
            });
            fromClause += `\n    from ${testTableInfo.tableName}\n    where pt='\${-1d_pt}'\n) t2`;

            // æ„å»ºONå­å¥
            let onClause = '\non ';
            primaryKeyMappings.forEach((mapping, index) => {
                onClause += `${index === 0 ? '' : ' and '}t1.${mapping.onlineField}=t2.${mapping.testField}`;
            });

            // æ„å»ºWHEREå­å¥
            let whereClause = '\nwhere ';
            primaryKeyMappings.forEach((mapping, index) => {
                whereClause += `${index === 0 ? '' : ' or '}t1.${mapping.onlineField} is null or t2.${mapping.testField} is null`;
            });
            
            dataFieldMappings.forEach(mapping => {
                whereClause += `\nor nvl(t1.${mapping.onlineField},'')<>nvl(t2.${mapping.testField},'')`;
            });

            return selectClause + fromClause + onClause + whereClause;
        }

        /**
         * å¤åˆ¶SQLåˆ°å‰ªè´´æ¿
         */
        function copySQL() {
            const sqlText = document.getElementById('resultSQL').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                showAlert('SQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿!');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = sqlText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showAlert('SQLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿!');
            });
        }

        /**
         * æ›´æ–°è¿›åº¦æ¡
         */
        function updateProgressBar(percentage) {
            document.getElementById('progressBar').style.width = percentage + '%';
        }
    </script>
</body>
</html>